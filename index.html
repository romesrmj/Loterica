<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gerador de Crachás Lotérica</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- React e ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- html2canvas e jsPDF -->
  <script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- Babel para JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; }
    label { display: block; margin-bottom: 10px; }
    input, button { font-size: 0.9rem; margin-top: 2px; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useRef, useState } = React;

    function BadgeGenerator() {
      const previewRef = useRef(null);

      const [photo, setPhoto] = useState("");
      const [logo, setLogo] = useState("");
      const [logoFederal, setLogoFederal] = useState("");

      const [photoURL, setPhotoURL] = useState("");
      const [logoURL, setLogoURL] = useState("");
      const [logoFederalURL, setLogoFederalURL] = useState("");

      const [firstName, setFirstName] = useState("");
      const [lastName, setLastName] = useState("");
      const [cpf, setCpf] = useState("");
      const [lotericaName, setLotericaName] = useState("Nome da Lotérica");

      const DPI = 300;
      const CSS_DPI = 96;
      const scale = DPI / CSS_DPI;

      // Converte arquivo em base64
      const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = err => reject(err);
        reader.readAsDataURL(file);
      });

      const handleUpload = async (e, setter) => {
        const f = e.target.files?.[0];
        if(!f) return;
        const b64 = await toBase64(f);
        setter(b64);
      };

      const exportPDF = async () => {
        if(!previewRef.current) return;
        const imgs = previewRef.current.querySelectorAll("img");
        await Promise.all(Array.from(imgs).map(i => i.complete ? Promise.resolve() : new Promise(res => { i.onload=i.onerror=res; })));

        const canvas = await html2canvas(previewRef.current, { scale, useCORS:true, allowTaint:true, backgroundColor:"#fff" });
        const imgData = canvas.toDataURL("image/png",1.0);
        const pdf = new window.jspdf.jsPDF({ unit:"mm", format:[54,86], orientation:"portrait" });
        pdf.addImage(imgData,"PNG",0,0,54,86);

        const safeFirst = (firstName||"badge").replace(/[^a-z0-9-_]/gi,"_");
        const safeLast = (lastName||"badge").replace(/[^a-z0-9-_]/gi,"_");
        pdf.save(`${safeFirst}_${safeLast}.pdf`);
      };

      const clearAll = () => {
        setPhoto(""); setPhotoURL("");
        setLogo(""); setLogoURL("");
        setLogoFederal(""); setLogoFederalURL("");
        setFirstName(""); setLastName(""); setCpf(""); setLotericaName("Nome da Lotérica");
      };

      return (
        <div>
          <h2>Gerador de Crachás Lotérica (Vertical)</h2>
          <div style={{ display:"flex", gap:"20px" }}>
            <div style={{ flex:"1 1 300px" }}>
              <label>Logo da Lotérica (upload)
                <input type="file" accept="image/*" onChange={e=>handleUpload(e,setLogo)}/>
              </label>
              <label>Logo da Lotérica (URL)
                <input value={logoURL} onChange={e=>setLogoURL(e.target.value)} placeholder="https://..."/>
              </label>

              <label>Foto 3x4 (upload)
                <input type="file" accept="image/*" onChange={e=>handleUpload(e,setPhoto)}/>
              </label>
              <label>Foto 3x4 (URL)
                <input value={photoURL} onChange={e=>setPhotoURL(e.target.value)} placeholder="https://..."/>
              </label>

              <label>Nome<input value={firstName} onChange={e=>setFirstName(e.target.value)} /></label>
              <label>Sobrenome<input value={lastName} onChange={e=>setLastName(e.target.value)} /></label>
              <label>CPF<input value={cpf} onChange={e=>setCpf(e.target.value)} /></label>

              <label>Logo Loteria Federal (upload)
                <input type="file" accept="image/*" onChange={e=>handleUpload(e,setLogoFederal)}/>
              </label>
              <label>Logo Loteria Federal (URL)
                <input value={logoFederalURL} onChange={e=>setLogoFederalURL(e.target.value)} placeholder="https://..."/>
              </label>

              <label>Nome da Lotérica<input value={lotericaName} onChange={e=>setLotericaName(e.target.value)} /></label>

              <div style={{ marginTop:"10px" }}>
                <button onClick={exportPDF}>Gerar PDF</button>
                <button onClick={clearAll}>Limpar</button>
              </div>
            </div>

            <div style={{ flexShrink:0 }}>
              <div style={{ border:"1px solid #ccc", padding:"10px", background:"#eee" }}>
                <div ref={previewRef} style={{ width:"54mm", height:"86mm", borderRadius:"3mm", background:"#fff", display:"flex", flexDirection:"column", alignItems:"center", paddingTop:"6mm" }}>

                  {/* Logo Lotérica */}
                  <div style={{ width:"80%", height:"12mm", marginBottom:"5mm", display:"flex", alignItems:"center", justifyContent:"center" }}>
                    {logo ? <img src={logo} alt="logo" style={{maxWidth:"100%", maxHeight:"100%", objectFit:"contain"}}/>
                    : logoURL ? <img src={logoURL} alt="logo url" style={{maxWidth:"100%", maxHeight:"100%", objectFit:"contain"}}/>
                    : <div style={{ fontSize:"9pt", color:"#666"}}>Logo Lotérica</div>}
                  </div>

                  {/* Foto 3x4 */}
                  <div style={{ width:"22mm", height:"30mm", border:"2px solid #0166B3", marginBottom:"5mm", borderRadius:"2mm", overflow:"hidden" }}>
                    {photo ? <img src={photo} alt="3x4" style={{width:"100%",height:"100%",objectFit:"cover"}}/>
                    : photoURL ? <img src={photoURL} alt="3x4 url" style={{width:"100%",height:"100%",objectFit:"cover"}}/>
                    : <div style={{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",color:"#666"}}>3x4</div>}
                  </div>

                  {/* Nome + CPF */}
                  <div style={{ textAlign:"center", marginBottom:"5mm", color:"#0166B3" }}>
                    <div style={{ fontWeight:700 }}>{(firstName||"Nome")+" "+(lastName||"Sobrenome")}</div>
                    <div>{cpf||"000.000.000-00"}</div>
                  </div>

                  {/* Logo Federal */}
                  <div style={{ width:"70%", height:"10mm", display:"flex", alignItems:"center", justifyContent:"center", marginBottom:"4mm" }}>
                    {logoFederal ? <img src={logoFederal} alt="federal" style={{maxWidth:"100%", maxHeight:"100%", objectFit:"contain"}}/>
                    : logoFederalURL ? <img src={logoFederalURL} alt="federal url" style={{maxWidth:"100%", maxHeight:"100%", objectFit:"contain"}}/>
                    : <div style={{ fontSize:"9pt", color:"#666"}}>Logo Loteria Federal</div>}
                  </div>

                  {/* Footer */}
                  <div style={{ marginTop:"auto", textAlign:"center", fontWeight:500, backgroundColor:"#0166B3", color:"#fff", width:"100%", padding:"2mm 0" }}>
                    {lotericaName}
                  </div>

                </div>
              </div>
              <div style={{ fontSize:"10px", marginTop:"2px" }}>Modelo vertical — 54 × 86 mm</div>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<BadgeGenerator />, document.getElementById("root"));
  </script>
</body>
</html>
